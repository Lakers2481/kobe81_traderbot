# Kobe Trading System - Base Configuration
# This file contains global settings for the trading system

system:
  name: "Kobe"
  version: "1.0.0"
  mode: "paper"  # paper | live
  timezone: "America/New_York"

# Data Provider Settings
data:
  provider: "polygon"
  cache_dir: "data/cache"
  universe_file: "data/universe/optionable_liquid_900.csv"

# Backtest Settings
backtest:
  initial_capital: 100000
  slippage_pct: 0.001  # 0.1% slippage estimate
  # Commission model (config-gated)
  commissions:
    enabled: false  # Set true to apply commission model
    per_share: 0.0  # $ per share (e.g., 0.005 for IBKR Pro)
    min_per_order: 0.0  # Minimum $ per order
    bps: 0.0  # Basis points of notional (alternative to per_share)
    sec_fee_per_dollar: 0.0000278  # SEC fee (~$27.80 per $1M sold)
    taf_fee_per_share: 0.000166  # FINRA TAF (~$0.000166/share sold)

# Walk-Forward Settings
walk_forward:
  train_days: 252  # 1 year training
  test_days: 63    # 1 quarter testing

# Risk Management
risk:
  max_position_size: 0.10  # 10% of portfolio per position
  max_daily_loss: 1000     # $1,000 daily loss limit
  max_order_value: 75      # $75 per order (micro budget)
  max_open_positions: 10   # Maximum concurrent positions

# Strategy Filters (config-gated)
filters:
  # Earnings proximity filter
  earnings:
    enabled: true  # Skip signals near earnings
    days_before: 2  # Skip N days before earnings
    days_after: 1   # Skip N days after earnings
    cache_file: "state/earnings_cache.json"  # Cache earnings dates

# Execution Settings
execution:
  broker: "alpaca"
  order_type: "ioc_limit"  # IOC LIMIT orders only
  limit_buffer: 0.001      # 0.1% above ask for buys
  # LULD/Volatility clamp (config-gated)
  clamp:
    enabled: true  # Enable LULD/volatility clamp
    max_pct_from_quote: 0.02  # Max 2% from last quote
    use_atr: false  # Alternative: clamp to ATR band
    atr_multiple: 2.0  # ATR(14) × multiple
  # Rate limiter (config-gated)
  rate_limiter:
    enabled: true  # Enable rate limiting for safety
    max_orders_per_minute: 120  # Token bucket capacity
    retry_on_429: true  # Retry with exponential backoff on 429
    max_retries: 3  # Max retry attempts
    base_delay_ms: 500  # Initial backoff delay

# Logging
logging:
  level: "INFO"
  events_file: "logs/events.jsonl"
  trades_file: "logs/trades.jsonl"

# Health Check
health:
  enabled: true
  port: 8081
  endpoint: "/health"
  # Metrics endpoint (config-gated)
  metrics:
    enabled: true  # Expose /metrics JSON endpoint
    include_performance: true  # Include WR, PF, Sharpe from last run
    include_requests: true  # Include request counters

# Kill Switch
kill_switch:
  file: "state/KILL_SWITCH"

# Audit
audit:
  hash_chain_file: "state/hash_chain.jsonl"
  verify_on_startup: true

# Regime Filter (config-gated, equities only)
regime_filter:
  enabled: true  # Enable regime filter by default
  trend:
    fast: 20      # Fast SMA period (optional, set 0 to disable)
    slow: 200     # Slow SMA period (SPY close > SMA(slow))
    require_above_slow: true  # Must be above slow SMA
  vol:
    window: 20    # Realized volatility window (days)
    max_ann_vol: 0.25  # Max annualized vol threshold (e.g., 0.25 for 25%)

# Signal Selection (config-gated)
selection:
  enabled: false  # Disabled in two-strategy setup (no cross-sectional TOPN)
  top_n: 5        # Ignored when selection.enabled is false
  # Note: legacy RSI2/IBS/CRSI weights removed; selection not used for IBS_RSI/ICT
  min_price: 10.0  # Generic floor used by some helpers when present

# Signal Quality Gate (v2.0 - reduces ~50/week to ~5/week)
quality_gate:
  enabled: true
  min_score_to_pass: 70.0  # Minimum composite score to pass gate
  max_signals_per_day: 1   # Target: 5 trades/week

  # Component weights (total = 100)
  weights:
    conviction: 30     # ML conviction score
    ml_confidence: 25  # ML meta-model confidence
    strategy: 15       # Raw strategy score
    regime: 15         # Regime alignment
    liquidity: 15      # ADV-based liquidity score

  # Quality tiers
  tiers:
    elite: 90          # Trade full size
    excellent: 80      # Trade full size
    good: 70           # Trade 80% size
    marginal: 60       # Skip

  # Liquidity requirements
  liquidity:
    min_adv_usd: 5000000       # $5M minimum ADV
    preferred_adv_usd: 20000000  # $20M for full score
    max_spread_pct: 0.02       # 2% max spread

  # Timing penalties
  timing:
    monday_penalty: 1.0        # Points deducted
    friday_penalty: 1.5        # Higher weekend risk

  # Volatility penalties
  volatility:
    vix_elevated: 25.0         # 2.5 point penalty above this
    vix_high: 35.0             # 5 point penalty above this

# Volatility-Targeted Sizing (config-gated)
sizing:
  enabled: false  # Set true to use ATR-based position sizing
  risk_per_trade_pct: 0.005  # 0.5% of equity per trade
  atr_multiple_for_stop: 2.0  # Stop = entry - ATR(14) × multiple

# Multi-Asset Scheduler (Top-1% Gaps)
scheduler:
  equities:
    enabled: true
    scan_times: "09:35,10:30,15:55"  # ET times
  crypto:
    enabled: false  # Disabled by default
    cadence_hours: 4  # Scan every 4 hours
    universe_file: "data/universe/crypto_top10.csv"
  options:
    enabled: false  # Disabled by default

# Portfolio Risk Gate (Top-1% Gaps)
portfolio_risk:
  enabled: true
  limits:
    max_gross_exposure_pct: 100  # 100% of NAV
    max_single_name_pct: 10     # 10% per position
    max_sector_pct: 30          # 30% per sector
    max_correlated_basket_pct: 40  # 40% in correlated positions
    max_simultaneous_positions: 20
    correlation_threshold: 0.70
    correlation_window_days: 20
  sector_map_file: "data/sector_map.csv"

# Execution Guard (Top-1% Gaps)
execution_guard:
  enabled: true
  max_quote_age_seconds: 5.0
  max_spread_pct: 0.50  # 0.50%
  stand_down_on_uncertainty: true  # CRITICAL: Reject on ANY doubt

# Backtest Realism (Top-1% Gaps)
backtest_realism:
  slippage:
    type: "fixed_bps"  # fixed_bps, atr_fraction, spread_percentile, volume_impact
    bps: 5.0           # 5 bps default
    atr_fraction: 0.10
  costs:
    enabled: true      # Enable realistic costs by default
    include_sec_fee: true
    include_finra_taf: true
  fill_model:
    type: "limit_order"  # always, limit_order, probabilistic, partial
    use_open_for_gap: true

# Live Trading Safety (Top-1% Gaps)
live_trading:
  require_env_approval: true   # Requires LIVE_TRADING_APPROVED=YES
  require_cli_flag: true       # Requires --approve-live flag
  double_confirmation: true    # Both required for live trading

# Supervisor Settings (Top-1% Gaps)
supervisor:
  enabled: true
  check_interval_seconds: 60
  max_error_count: 5
  error_window_minutes: 15
  max_restart_attempts: 3

# Cognitive Architecture Settings
cognitive:
  # Master switch for the cognitive layer
  enabled: true

  # CognitiveBrain settings
  brain:
    min_confidence_to_act: 0.5        # Minimum confidence required to take action
    max_processing_time_ms: 5000      # Timeout for deliberation process

  # MetacognitiveGovernor settings (System 1/System 2 routing)
  governor:
    fast_confidence_threshold: 0.75   # Confidence needed to trust fast path
    slow_confidence_threshold: 0.50   # Confidence below which slow path triggers
    stand_down_threshold: 0.30        # Confidence below which we don't act
    default_fast_budget_ms: 100       # Time budget for fast path
    default_slow_budget_ms: 5000      # Time budget for slow path
    high_stakes_position_pct: 0.03    # Trades above 3% trigger slow path

  # ReflectionEngine settings
  reflection:
    max_reflections: 100              # Max stored reflections in history
    lookback_hours: 24                # Default lookback for periodic reflection

  # SelfModel settings
  self_model:
    state_dir: "state/cognitive"      # Directory for persisting self-model
    auto_persist: true                # Auto-save after each update
    poor_capability_threshold: 0.35   # Win rate below which capability is POOR
    excellent_capability_threshold: 0.65  # Win rate above which capability is EXCELLENT
    min_trades_for_rating: 10         # Minimum trades before assigning capability
    max_calibration_error: 0.25       # Max error before recommending stand-down

  # KnowledgeBoundary settings
  knowledge_boundary:
    uncertainty_threshold: 0.3        # Score above which situation is "uncertain"
    stand_down_threshold: 0.6         # Score above which stand-down is recommended
    min_samples_for_confidence: 5     # Minimum historical samples needed

  # EpisodicMemory settings
  episodic_memory:
    storage_dir: "state/cognitive/episodes"
    max_active_episodes: 100          # Max concurrent active episodes
    max_completed_episodes: 1000      # Max stored completed episodes
    auto_persist: true                # Auto-save completed episodes

  # SemanticMemory settings
  semantic_memory:
    state_dir: "state/cognitive"
    min_rule_confidence: 0.4          # Minimum confidence to keep a rule
    max_rules: 500                    # Maximum stored rules

  # CuriosityEngine settings
  curiosity:
    max_hypotheses: 50                # Maximum active hypotheses
    validation_threshold: 0.7         # Confidence needed to promote hypothesis

  # MarketMoodAnalyzer settings (Task A2)
  market_mood:
    vix_weight: 0.6                   # Weight for VIX in mood calculation
    sentiment_weight: 0.4             # Weight for sentiment in mood calculation
    extreme_threshold: 0.7            # |mood_score| threshold for extreme mood
    vix_fear_level: 25.0              # VIX level indicating fear
    vix_greed_level: 15.0             # VIX level indicating greed
    vix_extreme_fear_level: 35.0      # VIX level indicating extreme fear
    vix_extreme_greed_level: 12.0     # VIX level indicating extreme greed
