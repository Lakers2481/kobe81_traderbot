%%{init: {'theme': 'dark', 'themeVariables': {'fontSize': '14px'}}}%%
flowchart TB
    subgraph Title["KOBE AUTONOMOUS TRADING SYSTEM"]
        direction TB
    end

    subgraph Brain["24/7 AUTONOMOUS BRAIN"]
        BRAIN_CORE["brain.py<br/>60-second cycles"]
        AWARENESS_CORE["awareness.py<br/>9 phases, 8 seasons"]
        SCHEDULER_CORE["scheduler.py<br/>43 tasks"]
    end

    subgraph Strategy["DUAL STRATEGY SCANNER"]
        IBS["IBS+RSI<br/>59.9% WR, 1.46 PF"]
        TS["Turtle Soup<br/>61.0% WR, 1.37 PF"]
    end

    subgraph Gates["5-GATE QUANT VALIDATION"]
        G0["Gate 0: Sanity"]
        G1["Gate 1: Baseline"]
        G2["Gate 2: Robustness"]
        G3["Gate 3: Risk"]
        G4["Gate 4: FDR"]
    end

    subgraph Risk["RISK MANAGEMENT"]
        R1["2% per trade"]
        R2["20% daily cap"]
        R3["40% weekly cap"]
        KZ["Kill Zones<br/>9:30-10:00 blocked"]
    end

    subgraph ML["ML/AI LAYER"]
        HMM_M["HMM Regime<br/>Bull/Bear/Neutral"]
        LSTM_M["LSTM Confidence<br/>A/B/C grades"]
        ENS["Ensemble<br/>XGBoost + LightGBM"]
    end

    subgraph Safety["SAFETY"]
        PAPER["PAPER_ONLY = True"]
        KILL["Kill Switch<br/>state/KILL_SWITCH"]
    end

    subgraph Execution["EXECUTION"]
        ALPACA["Alpaca<br/>IOC LIMIT"]
        POS["Positions<br/>Tracking"]
    end

    subgraph Data["DATA"]
        POLYGON["Polygon.io<br/>EOD OHLCV"]
        UNIVERSE["900 Stocks<br/>10+ years"]
    end

    %% Connections
    BRAIN_CORE --> AWARENESS_CORE
    AWARENESS_CORE --> SCHEDULER_CORE

    SCHEDULER_CORE --> IBS
    SCHEDULER_CORE --> TS

    IBS --> G0
    TS --> G0
    G0 --> G1 --> G2 --> G3 --> G4

    G4 --> R1
    R1 --> R2 --> R3
    R3 --> KZ

    HMM_M --> ENS
    LSTM_M --> ENS
    ENS --> IBS
    ENS --> TS

    KZ --> PAPER
    PAPER --> KILL
    KILL --> ALPACA
    ALPACA --> POS

    POLYGON --> UNIVERSE
    UNIVERSE --> IBS
    UNIVERSE --> TS

    %% Key metrics callout
    subgraph Metrics["KEY METRICS"]
        M1["Win Rate: ~60%"]
        M2["Profit Factor: ~1.40"]
        M3["Max DD: <15%"]
        M4["Tests: 942"]
    end

    classDef brain fill:#3498db,stroke:#2980b9,color:#fff
    classDef strategy fill:#2ecc71,stroke:#27ae60,color:#fff
    classDef gates fill:#9b59b6,stroke:#8e44ad,color:#fff
    classDef risk fill:#e74c3c,stroke:#c0392b,color:#fff
    classDef ml fill:#f1c40f,stroke:#f39c12,color:#2c3e50
    classDef safety fill:#e74c3c,stroke:#c0392b,color:#fff,stroke-width:3px
    classDef exec fill:#1abc9c,stroke:#16a085,color:#fff
    classDef data fill:#34495e,stroke:#2c3e50,color:#ecf0f1
    classDef metrics fill:#2c3e50,stroke:#1abc9c,color:#1abc9c

    class BRAIN_CORE,AWARENESS_CORE,SCHEDULER_CORE brain
    class IBS,TS strategy
    class G0,G1,G2,G3,G4 gates
    class R1,R2,R3,KZ risk
    class HMM_M,LSTM_M,ENS ml
    class PAPER,KILL safety
    class ALPACA,POS exec
    class POLYGON,UNIVERSE data
    class M1,M2,M3,M4 metrics
